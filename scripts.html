<!-- src/scripts.html -->
<script>
  /**
   * Carrega uma página HTML específica dentro do conteúdo principal.
   *
   * @param {string} page - Nome da página a ser carregada.
   */
  function loadPage(page) {
    console.log("Função loadPage chamada para: " + page);
    google.script.run.withSuccessHandler(function(html) {
      console.log("Conteúdo HTML recebido para a página: " + page);
      const contentDiv = document.getElementById('content');
      if (contentDiv) {
        contentDiv.innerHTML = html;
        console.log("Conteúdo inserido no elemento 'content'.");
        
        // Inicializar funcionalidades específicas da página carregada
        if (page === 'contas_a_pagar') {
          console.log("Inicializando funcionalidades de 'contas_a_pagar'.");
          carregarContasAPagar();
        }
        // Adicione chamadas para outras páginas conforme necessário
      } else {
        console.error("Elemento 'content' não encontrado.");
      }
    }).withFailureHandler(function(error) {
      console.error("Erro ao carregar a página: " + error.message);
      alert("Ocorreu um erro ao carregar a página. Verifique o console para mais detalhes.");
    }).getPage(page);
  }
  
  /**
   * Exibe ou oculta o formulário de adicionar conta a pagar.
   */
  function mostrarFormulario() {
    console.log("Função mostrarFormulario chamada.");
    const form = document.getElementById('formulario');
    if (form) {
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
      console.log("Exibindo formulário: " + (form.style.display === 'block' ? "Sim" : "Não"));
    } else {
      console.error("Elemento 'formulario' não encontrado.");
    }
  }
  
  /**
   * Inicializa os event listeners após o carregamento do DOM.
   */
  document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM completamente carregado e analisado.");
    // Carregar a página inicial
    loadPage('contas_a_pagar');

    // Adicionar event listener para o formulário de Contas a Pagar
    const form = document.getElementById('formContaAPagar');
    if (form) {
      form.addEventListener('submit', function(e) {
        e.preventDefault();
        console.log("Formulário 'formContaAPagar' submetido.");

        // Coletar os dados do formulário
        const tipo = document.getElementById('tipo').value.trim();
        const banco = document.getElementById('banco').value.trim();
        const data = document.getElementById('data').value;
        const valor = parseFloat(document.getElementById('valor').value);
        const controle_pagamento = document.getElementById('controle_pagamento').value.trim();
        const vencimento = document.getElementById('vencimento').value;
        const alertas = document.getElementById('alertas').value.trim();
        const id = document.getElementById('id').value.trim();

        const conta = {
          tipo: tipo,
          banco: banco,
          data: data,
          valor: valor,
          controle_pagamento: controle_pagamento,
          vencimento: vencimento,
          alertas: alertas,
          id: id
        };
        console.log("Dados do formulário coletados: ", conta);

        // Validar se todos os campos obrigatórios estão preenchidos
        if (!tipo || !banco || !data || isNaN(valor) || !controle_pagamento || !vencimento || !id) {
          console.error("Erro: Preencha todos os campos obrigatórios.");
          alert("Por favor, preencha todos os campos obrigatórios.");
          return;
        }

        // Verificar se o ID não contém caracteres inválidos (opcional)
        if (id.includes('/') || id.includes('\\')) {
          console.error("Erro: O ID não pode conter barras ou caracteres especiais.");
          alert("O ID não pode conter barras ou caracteres especiais.");
          return;
        }

        // Chamar a função do servidor para adicionar a conta a pagar
        console.log("Enviando dados para o servidor: ", conta);
        google.script.run.withSuccessHandler(function(response) {
          console.log("Resposta do servidor recebida: ", response);
          if (response.success) {
            alert(response.message);
            console.log("Resetando o formulário.");
            form.reset();
            document.getElementById('formulario').style.display = 'none';
            carregarContasAPagar();
          } else {
            alert('Erro: ' + response.message);
            console.error("Erro ao adicionar conta: " + response.message);
          }
        }).withFailureHandler(function(error) {
          console.error("Erro ao executar adicionarContaAPagar: " + error.message);
          alert("Ocorreu um erro ao salvar a conta. Verifique o console para mais detalhes.");
        }).adicionarContaAPagar(conta);
      });
    } else {
      console.error("Elemento 'formContaAPagar' não encontrado.");
    }
  });
  
  /**
   * Carrega e exibe a lista de contas a pagar na tabela.
   */
  function carregarContasAPagar() {
    console.log("Função carregarContasAPagar chamada.");
    google.script.run.withSuccessHandler(function(data) {
      console.log("Dados de contas a pagar recebidos: ", data);
      const lista = document.getElementById('listaContas');
      if (lista) {
        let html = '<table>';
        html += '<tr><th>ID</th><th>Alertas</th><th>Vencimento</th><th>Controle de Pagamento</th><th>Valor</th><th>Data</th><th>Banco</th><th>Tipo</th></tr>';
        data.forEach(row => {
          html += `<tr>
                    <td>${row[0]}</td>
                    <td>${row[1]}</td>
                    <td>${row[2]}</td>
                    <td>R$ ${parseFloat(row[4]).toFixed(2)}</td>
                    <td>${row[3]}</td>
                    <td>${row[5]}</td>
                    <td>${row[6]}</td>
                    <td>${row[7]}</td>
                   </tr>`;
        });
        html += '</table>';
        lista.innerHTML = html;
        console.log("Tabela de contas a pagar atualizada.");
      } else {
        console.error("Elemento 'listaContas' não encontrado.");
      }
    }).withFailureHandler(function(error) {
      console.error("Erro ao carregar contas a pagar: " + error.message);
      alert("Ocorreu um erro ao carregar as contas a pagar. Verifique o console para mais detalhes.");
    }).getContasAPagar();
  }
</script>
